name: Deploy to Namecheap

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Export static files
        run: npm run export

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./out/
          server-dir: ${{ secrets.FTP_DIRECTORY }}
          dangerous-clean-slate: true

      # 创建必要的目录 
      - name: Create required directories
        run: |
          mkdir -p public/images/icons
          touch public/images/icons/lab-environment.png
          touch public/images/icons/exam-materials.png
          touch public/images/icons/expert-guidance.png
          touch public/images/simulator-preview.jpg

      # 添加.htaccess文件处理Next.js路由
      - name: Add .htaccess for SPA routing
        run: |
          echo 'Options -MultiViews' > ./out/.htaccess
          echo 'RewriteEngine On' >> ./out/.htaccess
          echo 'RewriteCond %{REQUEST_FILENAME} !-f' >> ./out/.htaccess
          echo 'RewriteCond %{REQUEST_FILENAME} !-d' >> ./out/.htaccess
          echo 'RewriteRule ^ index.html [QSA,L]' >> ./out/.htaccess

      # 更新更改日志
      - name: Update changelog
        run: |
          echo "## 部署记录" >> docs/deployment_log.md
          echo "- 日期: $(date '+%Y-%m-%d %H:%M:%S')" >> docs/deployment_log.md
          echo "- 提交: ${{ github.sha }}" >> docs/deployment_log.md
          echo "- 触发者: ${{ github.actor }}" >> docs/deployment_log.md
          echo "" >> docs/deployment_log.md 